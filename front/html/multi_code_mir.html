<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <!--codeMirror-->
    @@include('include/common_style.html')
    <!--zTree-->
    <link rel="stylesheet" href="../css/metroStyle.css" type="text/css">
    <link rel="stylesheet" href="../css/codepen.css" type="text/css">
    <style>
        .CodeMirror {
            height: 50%;
        }

        .flex-select {
            height: 5%;
        }
    </style>
</head>
<body>
<div class="main">
    <div class="flex-select">
        <button value="运行">运行</button>
    </div>
    <div class="flex-box">
        <div id="tree" class="doc-tree">
            <div class="zTreeDemoBackground left">
                <ul id="treeDemo" class="ztree"></ul>
            </div>
        </div>
        <textarea id="editor" name="editor"></textarea>
    </div>
    <div class="flex-box flex-line"></div>
    <div class="flex-box flex-out">
        //这里是输出
    </div>

    <input type="file" id="patch_upload" style="display: none" multiple="multiple">

</div>


<!--Basic-->
@@include('include/common_lib.html')
@@include('include/common_language.html')

<!--tree-->
<script type="text/javascript" src="../js/jquery.ztree.core.js"></script>
<script type="text/javascript" src="../js/jquery.ztree.excheck.js"></script>
<script type="text/javascript" src="../js/jquery.ztree.exedit.js"></script>


<script>
    $(() => {


        function beforeDrag(treeId, treeNodes) {
            for (var i = 0, l = treeNodes.length; i < l; i++) {
                if (treeNodes[i].drag === false) {
                    return false;
                }
            }
            return true;
        }

        function beforeDrop(treeId, treeNodes, targetNode, moveType) {
            return targetNode ? targetNode.drop !== false : true;
        }

        function onDblClick(event, treeId, treeNode) {
            alert(treeNode ? treeNode.tId + ", " + treeNode.name : "isRoot");
        }

        //构造树形目录
        var setting = {
            view: {
                addHoverDom: addHoverDom,//添加h鼠标移入编辑栏事件
                removeHoverDom: removeHoverDom,//添加鼠标移出编辑栏事件
                selectedMulti: true //开启多选
            },
            check: {
                enable: true //复选开启
            },
            data: {
                simpleData: {
                    enable: true
                }
            },
            edit: {
                enable: true
            },
            callback: {
                beforeDrag: beforeDrag,
                beforeDrop: beforeDrop,
                onDblClick: onDblClick
            }
        };
        //添加json
        var zNodes = [
            {id: 1, pId: 0, name: "父节点1", open: true},
            {id: 11, pId: 1, name: "父节点11"},
            {id: 111, pId: 11, name: "叶子节点111"},
            {id: 112, pId: 11, name: "叶子节点112"},
            {id: 113, pId: 11, name: "叶子节点113"},
            {id: 114, pId: 11, name: "叶子节点114"},
            {id: 1111, pId: 114, name: "叶子节点1111"},
            {id: 12, pId: 1, name: "父节点12"},
            {id: 121, pId: 12, name: "叶子节点121"},
            {id: 122, pId: 12, name: "叶子节点122"},
            {id: 123, pId: 12, name: "叶子节点123"},
            {id: 124, pId: 12, name: "叶子节点124"},
            {id: 13, pId: 1, name: "父节点13", isParent: true},
            {id: 2, pId: 0, name: "父节点2"},
            {id: 21, pId: 2, name: "父节点21", open: true},
            {id: 211, pId: 21, name: "叶子节点211"},
            {id: 212, pId: 21, name: "叶子节点212"},
            {id: 213, pId: 21, name: "叶子节点213"},
            {id: 214, pId: 21, name: "叶子节点214"},
            {id: 22, pId: 2, name: "父节点22"},
            {id: 221, pId: 22, name: "叶子节点221"},
            {id: 222, pId: 22, name: "叶子节点222"},
            {id: 223, pId: 22, name: "叶子节点223"},
            {id: 224, pId: 22, name: "叶子节点224"},
            {id: 23, pId: 2, name: "父节点23"},
            {id: 231, pId: 23, name: "叶子节点231"},
            {id: 232, pId: 23, name: "叶子节点232"},
            {id: 233, pId: 23, name: "叶子节点233"},
            {id: 234, pId: 23, name: "叶子节点234"},
            {id: 3, pId: 0, name: "父节点3", isParent: true}
        ];

        var zTree = $.fn.zTree.init($("#treeDemo"), setting, zNodes);

        zTree.setting.edit.drag.isCopy = true;
        zTree.setting.edit.drag.isMove = true;

        zTree.setting.edit.drag.prev = true;
        zTree.setting.edit.drag.inner = true;
        zTree.setting.edit.drag.next = true;


        var newCount = 1;

        function addHoverDom(treeId, treeNode) {
            if (!(/\.[^\.]+/.test(treeNode.name))) {
                //有文件后缀不能上传和添加dom子节点
                var sObj = $("#" + treeNode.tId + "_span");
                if (treeNode.editNameFlag || $("#addBtn_" + treeNode.tId).length > 0 || $("#diyBtn_" + treeNode.tId).length > 0) return;//如果元素已存在gg
                var addStr = "<span class='button add' id='addBtn_" + treeNode.tId
                    + "' title='add node' onfocus='this.blur();'></span>";//拼接dom
                sObj.after(addStr);
                var diyStr = "<a id='diyBtn_" + treeNode.tId + "' style='margin:2 0 0 2px;'>上传</a>"
                sObj.after(diyStr)
                var btn = $("#addBtn_" + treeNode.tId);
                var diy = $("#diyBtn_" + treeNode.tId);


                /*
                * 绑定事件，追加子节点
                * */
                if (btn) btn.bind("click", function () {
                    var zTree = $.fn.zTree.getZTreeObj("treeDemo");
                    //$(treeNode).html("<input type=text class='rename' id='" + treeNode.tId + "'>");

                    zTree.addNodes(treeNode, {id: (100 + newCount), pId: treeNode.id, name: "new node"});
                    //添加编辑属性
                    var beans = treeNode.children;
                    zTree.editName(beans[0]);

                    return false;
                });

                if (diy) diy.bind("click", function () {
                    document.getElementById("patch_upload").click();
                })


            }
        };

        /**
         * 追加上传文件dom
         **/

        $("#patch_upload").on('change', function () {

            var filelist = this.files,
                zTree = $.fn.zTree.getZTreeObj("treeDemo");
//            console.log(filelist.length)
//            console.log(zTree.getSelectedNodes()[0])
            for (var i = 0; i < filelist.length; i++)
                zTree.addNodes(zTree.getSelectedNodes()[0], {
                    id: (100 + newCount),
                    pId: zTree.getSelectedNodes()[0].id,
                    name: filelist[i].name
                });
        })


        /**
         * 鼠标移出
         * @param treeId
         * @param treeNode
         */
        function removeHoverDom(treeId, treeNode) {
            $("#addBtn_" + treeNode.tId).unbind().remove();
            $("#diyBtn_" + treeNode.tId).unbind().remove();
        };


        //初始化编辑器

        var textarea = $("#editor")[0],
            mode = "javascript",
            keyMap = "sublime",
            options = {
                mode: mode,//加载模块
                theme: "base16-dark",
                keyMap: keyMap,//绑定编辑器键位
                lineNumbers: true,
                autofocus: true,
                lineWrapping: true,
                foldGutter: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],//代码折叠
                auto: "auto",
                matchBrackets: true,
                autoCloseBrackets: true,//括号补全
                autoCloseTags: true,//标签补全
                compvareSingle: false
            },
            codeEditor = CodeMirror.fromTextArea(textarea, options);

        codeEditor.setValue("//start from here!");

        codeEditor.on('keypress', () => {
            codeEditor.showHint(); //满足自动触发自动联想功能
        });

    })


</script>
</body>
</html>
